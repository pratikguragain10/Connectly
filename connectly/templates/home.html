{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- ================= STORIES SECTION ================= -->
<div class="stories-section">
  <div class="stories-container">
    <!-- Create Story -->
    <div class="story-card story-create">
      <div class="story-create-icon">+</div>
      <span>Create story</span>
    </div>

    <!-- Example Stories (you can make these dynamic later) -->
    <div class="story-card">
      <img src="{{ request.user.profile.profile_pic.url }}" class="story-avatar" alt="Story">
      <img src="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=400" alt="Story">
      <div class="story-overlay">Your Story</div>
    </div>
  </div>
</div>

<!-- ================= CREATE POST ================= -->
<div class="post-box">
  <form method="POST" enctype="multipart/form-data" action="{% url 'create_post' %}">
    {% csrf_token %}

    <div class="post-box-top">
      <img src="{{ request.user.profile.profile_pic.url }}" class="post-box-avatar" alt="{{ request.user.username }}">
      <textarea
        name="content"
        placeholder="What's on your mind, {{ request.user.username }}?"
        rows="1"
        class="post-textarea"
        oninput="autoResize(this)"
      ></textarea>
    </div>

    <!-- MEDIA PREVIEW -->
    <div class="media-preview" id="mediaPreview" style="display:none;">
      <button type="button" class="media-remove-btn" onclick="clearMedia()">âœ•</button>
      <img id="previewImage" style="display:none;">
      <video id="previewVideo" controls style="display:none;"></video>
    </div>

    <div class="post-box-bottom">
      <div class="post-box-actions">
        <button type="button" onclick="openImage()" class="post-box-action-btn">
          <span style="color:#45bd62;">ğŸ“·</span> Photo
        </button>
        <button type="button" onclick="openVideo()" class="post-box-action-btn">
          <span style="color:#f02849;">ğŸ¬</span> Video
        </button>
        <button type="button" class="post-box-action-btn">
          <span style="color:#f7b928;">ğŸ˜Š</span> Feeling/activity
        </button>
      </div>
      <button type="submit" class="post-btn">Post</button>
    </div>

    <input type="file" name="image" id="imageInput" accept="image/*" hidden>
    <input type="file" name="video" id="videoInput" accept="video/*" hidden>
  </form>
</div>

<!-- ================= POSTS ================= -->
{% for post in posts %}
<div class="post-card">

  <!-- HEADER -->
  <div class="post-header">
    <div class="post-user-info">
      <img src="{{ post.user.profile.profile_pic.url }}" class="post-avatar" alt="{{ post.user.username }}">
      <div>
        <strong>{{ post.user.username }}</strong>
        <div class="post-time">Just now Â· ğŸŒ</div>
      </div>
    </div>

    {% if post.user == request.user %}
    <div class="post-menu">
      <button class="menu-btn" onclick="event.stopPropagation(); toggleMenu({{ post.id }})">â‹¯</button>
      <div class="menu-dropdown" id="menu-{{ post.id }}" onclick="event.stopPropagation()">
        <a href="{% url 'edit_post' post.id %}">âœï¸ Edit post</a>
        <a href="{% url 'delete_post' post.id %}" class="danger">ğŸ—‘ï¸ Delete</a>
      </div>
    </div>
    {% endif %}
  </div>

  {% if post.content %}
    <p class="post-content">{{ post.content }}</p>
  {% endif %}

  {% if post.image %}
    <img src="{{ post.image.url }}" class="post-media">
  {% endif %}

  {% if post.video %}
    <video controls class="post-media">
      <source src="{{ post.video.url }}">
    </video>
  {% endif %}

  <!-- STATS -->
  <div class="post-stats">
    <div class="post-stats-left">
      <span class="like-icon">ğŸ‘</span>
      <span id="likes-count-{{ post.id }}">{{ post.likes.count }}</span>
    </div>
    <div>
      <span id="comments-count-{{ post.id }}">{{ post.comments.count }} comments</span>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="post-footer">
    <div class="post-actions-bar">
      <button class="action-btn like-btn {% if post.liked %}liked{% endif %}" onclick="toggleLike({{ post.id }}, this)">
        ğŸ‘ Like
      </button>
      <button class="action-btn comment-btn" onclick="toggleComments({{ post.id }})">
        ğŸ’¬ Comment
      </button>
      <button class="action-btn">
        â†—ï¸ Share
      </button>
    </div>
  </div>

  <!-- ================= COMMENTS ================= -->
  <div class="comments-wrapper" id="comments-{{ post.id }}" style="display:none;">
    <div class="comments" id="comments-list-{{ post.id }}">
      {% for comment in post.root_comments %}
        {% include "partials/comment.html" with comment=comment post=post level=0 %}
      {% endfor %}
    </div>

    <form onsubmit="submitComment(event, {{ post.id }})" class="comment-form">
      <img src="{{ request.user.profile.profile_pic.url }}" class="comment-form-avatar" alt="{{ request.user.username }}">
      <input type="text" placeholder="Write a comment..." required>
    </form>
  </div>

</div>
{% empty %}
<div class="post-card">
  <p style="text-align: center; padding: 20px; color: #65676b;">No posts yet. Start sharing!</p>
</div>
{% endfor %}

<!-- ================= JS ================= -->
<script>
/* ---------- AUTO RESIZE TEXTAREA ---------- */
function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
}

/* ---------- CSRF ---------- */
function getCSRFToken() {
  return document.cookie
    .split("; ")
    .find(row => row.startsWith("csrftoken="))
    ?.split("=")[1];
}

/* ---------- MEDIA PREVIEW ---------- */
const imageInput = document.getElementById("imageInput");
const videoInput = document.getElementById("videoInput");
const mediaPreview = document.getElementById("mediaPreview");
const previewImage = document.getElementById("previewImage");
const previewVideo = document.getElementById("previewVideo");

function openImage() {
  videoInput.value = "";
  imageInput.click();
}

function openVideo() {
  imageInput.value = "";
  videoInput.click();
}

imageInput.addEventListener("change", e => {
  if (!e.target.files[0]) return;
  previewVideo.style.display = "none";
  previewImage.src = URL.createObjectURL(e.target.files[0]);
  previewImage.style.display = "block";
  mediaPreview.style.display = "block";
});

videoInput.addEventListener("change", e => {
  if (!e.target.files[0]) return;
  previewImage.style.display = "none";
  previewVideo.src = URL.createObjectURL(e.target.files[0]);
  previewVideo.style.display = "block";
  mediaPreview.style.display = "block";
});

function clearMedia() {
  previewImage.src = "";
  previewVideo.src = "";
  previewImage.style.display = "none";
  previewVideo.style.display = "none";
  mediaPreview.style.display = "none";
  imageInput.value = "";
  videoInput.value = "";
}

/* ---------- MENU FIX ---------- */
let openMenuId = null;

function toggleMenu(postId) {
  const menu = document.getElementById(`menu-${postId}`);

  if (openMenuId === postId) {
    menu.style.display = "none";
    openMenuId = null;
    return;
  }

  document.querySelectorAll(".menu-dropdown").forEach(m => {
    m.style.display = "none";
  });

  menu.style.display = "block";
  openMenuId = postId;
}

document.addEventListener("click", () => {
  document.querySelectorAll(".menu-dropdown").forEach(m => {
    m.style.display = "none";
  });
  openMenuId = null;
});

/* ---------- COMMENTS ---------- */
function toggleComments(postId) {
  const box = document.getElementById(`comments-${postId}`);
  box.style.display = box.style.display === "block" ? "none" : "block";
}

/* ---------- LIKES ---------- */
function toggleLike(postId, btn) {
  fetch(`/posts/${postId}/like/`, {
    method: "POST",
    headers: { "X-CSRFToken": getCSRFToken() }
  })
  .then(res => res.json())
  .then(data => {
    btn.classList.toggle("liked", data.liked);
    document.getElementById(`likes-count-${postId}`).innerText = data.likes_count;
  });
}

function toggleCommentLike(commentId, btn) {
  fetch(`/comment-like/${commentId}/`, {
    method: "POST",
    headers: { "X-CSRFToken": getCSRFToken() }
  })
  .then(res => res.json())
  .then(data => {
    btn.classList.toggle("liked", data.liked);
    btn.querySelector("span").innerText = data.likes_count;
  });
}

/* ---------- COMMENTS AJAX ---------- */
function submitComment(event, postId) {
  event.preventDefault();
  const input = event.target.querySelector("input");

  fetch(`/comment/add/${postId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": getCSRFToken(),
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `content=${encodeURIComponent(input.value)}`
  })
  .then(res => res.text())
  .then(html => {
    document
      .getElementById(`comments-list-${postId}`)
      .insertAdjacentHTML("beforeend", html);
    input.value = "";
  });
}

function submitReply(event, postId, parentId) {
  event.preventDefault();
  const input = event.target.querySelector("input");

  fetch(`/comment/add/${postId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": getCSRFToken(),
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `content=${encodeURIComponent(input.value)}&parent=${parentId}`
  })
  .then(res => res.text())
  .then(html => {
    event.target.insertAdjacentHTML("afterend", html);
    event.target.style.display = "none";
    input.value = "";
  });
}

/* ---------- EDIT / DELETE COMMENTS ---------- */
function showEditForm(id) {
  document.getElementById(`edit-form-${id}`).style.display = "block";
}

function saveEdit(event, id) {
  if (event.key !== "Enter") return;

  fetch(`/comment/edit/${id}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": getCSRFToken(),
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `content=${encodeURIComponent(event.target.value)}`
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById(`comment-text-${id}`).innerText = data.content;
    document.getElementById(`edit-form-${id}`).style.display = "none";
  });
}

function deleteComment(id) {
  fetch(`/comment/delete/${id}/`, {
    method: "POST",
    headers: { "X-CSRFToken": getCSRFToken() }
  })
  .then(() => {
    document.getElementById(`comment-${id}`).remove();
  });
}

function toggleReplyForm(id) {
  const f = document.getElementById(`reply-form-${id}`);
  f.style.display = f.style.display === "block" ? "none" : "block";
}
</script>

{% endblock %}